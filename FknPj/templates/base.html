{% load static %}
<!DOCTYPE html>

<html>
        <!-- Basic Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Title (Dynamic) -->
    <title>
        {% block title %}
            Fikrin ‚Äì Thoughts, Words & Feelings Shared
        {% endblock %}
    </title>

    <!-- Primary SEO Meta -->
    <meta name="description"
          content="{% block meta_description %}
          Fikrin is a social writing platform where people share thoughts, emotions, poems, and perspectives in Malayalam and English.
          {% endblock %}">

    <meta name="keywords"
          content="Fikrin, Malayalam thoughts, poetry sharing, write feelings, social writing platform, Malayalam quotes, short stories, emotions">

    <meta name="author" content="Fikrin">
    <meta name="robots" content="index, follow">

    <!-- Canonical URL -->
    <link rel="canonical"
          href="{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock %}">

    <!-- Theme / PWA -->
    <meta name="theme-color" content="#000157">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Fikrin">

    <!-- Favicon -->
    <link rel="shortcut icon" href="{% static 'img/fkrnICN.png' %}">
    <link rel="apple-touch-icon" href="{% static 'img/fkrnICN.png' %}">

    <!-- ===================== -->
    <!-- Open Graph (Facebook, WhatsApp, LinkedIn) -->
    <!-- ===================== -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Fikrin">
    <meta property="og:title"
          content="{% block og_title %}Fikrin ‚Äì Thoughts That Speak{% endblock %}">
    <meta property="og:description"
          content="{% block og_description %}
          A place to share thoughts, emotions, poetry, and stories.
          {% endblock %}">
    <meta property="og:url"
          content="{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}">
    <meta property="og:image"
          content="{% block og_image %}
          {{ request.scheme }}://{{ request.get_host }}{% static 'img/og-default.png' %}
          {% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- ===================== -->
    <!-- Twitter / X -->
    <!-- ===================== -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title"
          content="{% block twitter_title %}Fikrin ‚Äì Thoughts That Speak{% endblock %}">
    <meta name="twitter:description"
          content="{% block twitter_description %}
          Share your thoughts and emotions with the world.
          {% endblock %}">
    <meta name="twitter:image"
          content="{% block twitter_image %}
          {{ request.scheme }}://{{ request.get_host }}{% static 'img/og-default.png' %}
          {% endblock %}">

    <!-- ===================== -->
    <!-- Performance & SEO -->
    <!-- ===================== -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    {% block extra_head %}{% endblock %}

        <!-- JavaScript to hide address bar on page load -->
        <script type="text/javascript">

            window.onload = function() {
                setTimeout(function() {
                    window.scrollTo(0, 1); // Scroll to hide the address bar
                }, 0);
            };
        </script>

        <script>
          // Function to handle notification click action
          function handleNotificationClick() {
              window.location.href = "https://fkrin.in/";
          }
        </script>

        {% block 'style' %}{% endblock 'style' %}

        <!-- CSS stylesheets -->
        <link rel="stylesheet" href="{% static 'css/styles_v1.css' %}">
        <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">

        <link rel="manifest" href="{% static 'manifest.json' %}">

        <!-- css Icons  -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">

        <!-- script for google adsense  -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6880040980136186"
        crossorigin="anonymous"></script>

        <script>
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyDkyNO4aWT4qVCVJwkcb354_Rtc-TdFybk",
                authDomain: "fknpj-9c7bb.firebaseapp.com",
                projectId: "fknpj-9c7bb",
                storageBucket: "fknpj-9c7bb.appspot.com",
                messagingSenderId: "624374608791",
                appId: "1:624374608791:web:143bdac26d9762dcbb0ad2",
                measurementId: "G-93ZXLVMBCF"
            };
          </script>

          <!-- Include Firebase JavaScript SDK -->
          <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
          <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

    </head>
    <body>

        {% block 'content' %}{% endblock 'content' %}

        {% block 'script' %}{% endblock 'script' %}

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

        <script>
          if ('serviceWorker' in navigator) {
              window.addEventListener('load', () => {
                  navigator.serviceWorker.register('/static/serviceworker.js')
                      .then((registration) => {
                          console.log('ServiceWorker registration successful with scope: ', registration.scope);
                      }, (err) => {
                          console.log('ServiceWorker registration failed: ', err);
                      });
              });
          }
      </script>

      <script type="module">
  console.log("üü¢ STEP 0: Script file loaded");

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-messaging.js";

  console.log("üü¢ STEP 1: Firebase modules imported");

  // üîπ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDkyNO4aWT4qVCVJwkcb354_Rtc-TdFybk",
    authDomain: "fknpj-9c7bb.firebaseapp.com",
    projectId: "fknpj-9c7bb",
    storageBucket: "fknpj-9c7bb.appspot.com",
    messagingSenderId: "624374608791",
    appId: "1:624374608791:web:143bdac26d9762dcbb0ad2",
  };

  console.log("üü¢ STEP 2: Firebase config ready");

  // üîπ Initialize Firebase
  const app = initializeApp(firebaseConfig);
  console.log("üü¢ STEP 3: Firebase initialized");

  // üîπ Register Service Worker
  let registration;
  try {
    registration = await navigator.serviceWorker.register('/static/serviceworker.js');
    console.log("üü¢ STEP 4: Service Worker registered", registration);
  } catch (swError) {
    console.error("üî¥ STEP 4 FAILED: Service Worker registration error", swError);
  }

  // üîπ Initialize Messaging
  const messaging = getMessaging(app);
  console.log("üü¢ STEP 5: Firebase messaging initialized");

  // üîπ Request notification permission
  try {
    console.log("üü¢ STEP 6: Requesting notification permission");

    const permission = await Notification.requestPermission();
    console.log("üü° Permission status:", permission);

    if (permission !== "granted") {
      console.error("üî¥ STEP 6 FAILED: Notification permission denied");
      throw new Error("Notification permission not granted");
    }

    console.log("üü¢ STEP 7: Permission granted");

  } catch (permissionError) {
    console.error("üî• Permission error:", permissionError);
  }

  // üîπ Get FCM token
  try {
    console.log("üü¢ STEP 8: Attempting to get FCM token");

    const token = await getToken(messaging, {
      vapidKey: "BD1y3vyzssdZQmFYYz9KQ_aw97CTJ-4XMyekXoovepWtDNv6z1ph-CN2SO1xcseBXmFxtuUyW14qY1dKPVDtJ4M",
      serviceWorkerRegistration: registration
    });

    if (token) {
      console.log("‚úÖ STEP 9 SUCCESS: FCM TOKEN GENERATED");
      console.log("üîë TOKEN:", token);

      // Send the token to Django to save it in the database
      // Adjust the URL to match your Django endpoint
      let saveTokenUrl = '/save-token/  ';

      // Ensure that the URL is accessible from your web app
      fetch(saveTokenUrl, {
        method: 'POST',
        // include cookies so Django can see request.user
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({
          'token': token
        })
      })

    } else {
      console.warn("‚ö†Ô∏è STEP 9 WARNING: Token is NULL");
    }

  } catch (tokenError) {
    console.error("üî• STEP 8 FAILED: Token generation error", tokenError);
  }

  console.log("üü¢ STEP 10: Script execution finished");

</script>

<!-- pop up window for sharing posts -->
<script>
document.addEventListener("click", function (e) {
    const btn = e.target.closest(".share-btn");
    if (!btn) return;

    if (!navigator.share) {
        alert("Sharing not supported");
        return;
    }

    console.log("Sharing:", btn.dataset.content, btn.dataset.url);

    navigator.share({
      title: "Fikrin Post",
      text: btn.dataset.content + "\n\nRead more on Fikrin:",
      url: btn.dataset.url
});

});
</script>

<!-- Instagram Sharing -->
<script>
  // Function to copy text for Instagram sharing
function copyInstagramText(text, url) {
    const finalText =
        text +
        "\n\n‚ú® Read more thoughts like this on Fikrin\nüîó " +
        url;

    navigator.clipboard.writeText(finalText).then(() => {
        alert("Content copied! Paste it into Instagram.");
    });
}
</script>

      {% comment %} <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional

        const firebaseConfig = {
            apiKey: "AIzaSyDkyNO4aWT4qVCVJwkcb354_Rtc-TdFybk",
            authDomain: "fknpj-9c7bb.firebaseapp.com",
            projectId: "fknpj-9c7bb",
            storageBucket: "fknpj-9c7bb.appspot.com",
            messagingSenderId: "624374608791",
            appId: "1:624374608791:web:143bdac26d9762dcbb0ad2",
            measurementId: "G-93ZXLVMBCF"
          };

        firebase.initializeApp(firebaseConfig);   // Initialize Firebase
        let messaging = firebase.messaging();   // Get Firebase Messaging instance

        navigator.serviceWorker.register('/static/serviceworker.js')
        .then(function(register) {
          messaging.useServiceWorker(register);

          // Request permission from the user to receive notifications
          messaging.requestPermission()
            .then(function() {
              console.log("The user has accepted to receive notifications.");
              return messaging.getToken();
            })
            .then(function(token){
              console.log(token);

              // Send the token to Django to save it in the database
              // Adjust the URL to match your Django endpoint
              let saveTokenUrl = '/save-token/';

              // Ensure that the URL is accessible from your web app
              fetch(saveTokenUrl, {
                method: 'POST',
                // include cookies so Django can see request.user
                credentials: 'same-origin',
                headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
                },
                body: JSON.stringify({
                  'token': token
                })
              })
              .then(function(response) {
                if (response.ok) {
                  console.log("Token has been saved");
                } else {
                  console.log("Failed to save token. Status: " + response.status);
                }
              })
              .catch(function(e) {
                console.error("An error occurred while saving the token:", e);
              });
            })
            .catch(function(e) {
              console.log("The user has not accepted to receive notifications.");
            });
        })
        .catch(function(e) {
          console.error("Failed to register the service worker:", e);
        });

      </script> {% endcomment %}

    </body>
</html>
